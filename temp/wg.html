<!DOCTYPE html>
<head xmlns:Accept-Language="http://www.w3.org/1999/xhtml">
    <meta Accept-Language: fr-CH, fr;q=0.9, en;q=0.8, de;q=0.7, *;q=0.5 />
    <title>{{ title }}</title>
    <link rel="shortcut icon" type="image/x-icon" href="static/img/favicon.ico"/>
    {% module xsrf_form_html() %}

    </head>
<body>
    <a href="/home">[ Home ]</a> <a href="/autoScript">[ AutoScript ]</a><br>
    <input type="number" maxlength="4" id="server_num_input" placeholder="WG服务端个数[x]" required><br>
    <input type="number" maxlength="4" id="client_num_input" placeholder="WG客户端个数[x]" required><br>
    <input type="number" maxlength="4" id="prekey_num_input" placeholder="共享密钥个数[x]" required><br>
    <button type="button" onclick="getWgConf('{{ request.path }}')">自动生成WireGuard配置</button>
    <div id="qrcode"></div>
</body>
<style>

</style>
<script type="text/javascript" src="/static/js/jquery-3.6.0.min.js"></script>
<script type="text/javascript" src="/static/js/qrcode.min.js"></script>
<script>
const T_FORM = 'application/x-www-form-urlencoded'
const T_JSON = 'application/json';

function getCookie(name) {
    var r = document.cookie.match("\\b" + name + "=([^;]*)\\b");
    return r ? r[1] : undefined;
}

function setCookie(cname, cvalue, exdays){
    let d = new Date();
    d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
    let expires = "expires="+d.toUTCString();
    document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}

window.onload=function(){
    const xsrf = getCookie('_xsrf');
    //_xsrf Header Setup for Ajax
    function xsrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!xsrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-XSRFToken", xsrf);
            }
        }
    });
}

function ajaxHandler(url,data,datatype,type){
  $.ajax({
    url:url,
    data:data,
    dataType:datatype,
    type:type,
    error:function(d){
      console.log(d);
    },
    success:function(d){
      console.log(d);
    },
    complete:function(d){
      console.log(d);
    },
  });
}

function genWgConfig(d){
  let s = d.server;
  let c = d.client;
  let p = d.prekey;
  let s_port = '443';
  let s_address = '100.64.0.1/24';
  let c_address = '100.64.0.1/24'
  let endpoint = '188.1.1.1:51280';
  let s_ifs = '';
  let s_peers = '';
  let clients = [];
  let servers = [];
  let list = {
    'server':{},
    'client':{},
  };
  for(var i=0;i<s.length;i++){
    for(var j=0;j<c.length;j++){
        let s_peer =`
[Peer]
PublicKey = ${ c[j].PublicKey }
PresharedKey = ${ p[j].PresharedKey }
AllowedIPs = 0.0.0.0/0

`;
let c_if = `
#client${ i }-${ j }.conf
[Interface]
PrivateKey = ${ c[j].PrivateKey }
Address = ${ c_address }
DNS = ${ s_address }
MTU = 1420

[Peer]
PublicKey = ${ s[i].PublicKey }
PresharedKey = ${ p[j].PresharedKey }
AllowedIPs = 0.0.0.0/0
Endpoint = ${ endpoint }
PersistentKeepalive = 25
`;
$('#qrcode').append(`<dev id="qrcode${ i }${ j }"></dev>`);
$('#qrcode').append(`<dev><a>[ Client${ i }-${ j } ]</a>
<pre backgroud-clo>${ c_if }<pre></dev>
`);
new QRCode(document.getElementById(`qrcode${ i }${ j }`), c_if);
        clients.push(c_if)
        s_peers += s_peer;
    }

      let s_if = `
#wg${ i }.conf
[Interface]
Address = ${ s_address }
ListenPort = ${ s_port }
PrivateKey = ${ s[i].PrivateKey }

${ s_peers }
`;
servers.push(s_if);
  }
console.log(clients);
console.log(servers);
}

function getWgConf(url){
  let server = $("#server_num_input").val();
  let client = $("#client_num_input").val();
  let prekey = $("#prekey_num_input").val();
  let type = 'post';
  let datatype = 'json';
  let data = JSON.stringify({
    "server": server,
    "client": client,
    "prekey": prekey,
  });
$.ajax({
    url:url,
    data:data,
    dataType:datatype,
    type:type,
    success:function(d){
      console.log(d);
      genWgConfig(d);
    },
  });
}

function next(url){
  console.log('redirect to===>' + url);
  if(url!=null){
    window.location.href = url;
  }
}

function genQrcode(id,str){
  new QRCode($("#"+id), str);
}
</script>
</html>